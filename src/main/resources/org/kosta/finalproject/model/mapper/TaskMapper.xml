<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kosta.finalproject.model.mapper.TaskMapper">

    <resultMap id="taskDTOMap" type="org.kosta.finalproject.model.domain.TaskDTO">
        <id property="taskNo" column="task_no"/>
        <result property="taskTitle" column="task_title"/>
        <result property="taskContent" column="task_content"/>
        <result property="taskRegdate" column="task_regdate"/>
    </resultMap>

    <select id="getRecentTaskList" parameterType="int" resultMap="taskDTOMap">
        select v.TASK_NO, v.TASK_TITLE, v.TASK_CONTENT, v.TASK_REGDATE
        from (
                 select TASK_NO, TASK_TITLE, TASK_CONTENT, TASK_REGDATE
                 from TASK t,
                      STUDY_MEMBER sm
                 where t.STUDY_NO = sm.STUDY_NO
                   and t.STUDY_NO = #{value}
                 order by TASK_REGDATE desc
             ) v
        where <![CDATA[ROWNUM <= 3]]>
    </select>

    <!--과제 공지사항 등록 -->
    <insert id="registerTask">
        insert into TASK(TASK_NO, TASK_TITLE, TASK_CONTENT, TASK_REGDATE, EMAIL, STUDY_NO)
        values (TASK_SEQ.nextval, #{taskTitle}, #{taskContent}, sysdate, #{email}, #{studyNo})
    </insert>

    <!-- 과제 공지사항 번호 조회 -->
    <select id="getTaskNoWhenRegister" resultType="int">
        select task_seq.currval
        from dual
    </select>

    <!-- 과제 파일 업로드 -->
    <insert id="registerAttachFile">
        INSERT INTO TASK_FILE
        VALUES (TASK_FILE_SEQ.nextval, #{attachFile.uploadFileName}, #{attachFile.storeFileName}, #{type},
                TASK_SEQ.CURRVAL)
    </insert>

    <!-- 과제 이미지 업로드 -->
    <insert id="registerStoreImage">
        INSERT INTO TASK_FILE
        VALUES (TASK_FILE_SEQ.nextval, #{storeImage.uploadFileName}, #{storeImage.storeFileName}, #{type},
                TASK_SEQ.CURRVAL)
    </insert>

</mapper>