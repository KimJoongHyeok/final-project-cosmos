<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="fragments/html-head.html :: fragment-html-head"></div>
</head>
<body>
<div th:replace="fragments/header.html :: fragment-header"></div>
<!-- Page Content-->
<section class="py-3">
    <div class="container col-lg-10 mt-3">
        <div class="row gx-5">
            <div class="col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex flex-column align-items-center text-center">
                            <img th:src="${study.get('PICTURE')}" class="rounded-circle" width="120" height="120">
                            <div class="mt-3">
                                <h4 class="text-break" th:text="${study.get('NAME')}">사용자 이름</h4>
                                <p class="text-secondary mb-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-9 content-area">
                <!-- 본문 영역 -->
                <div class="container col-lg-10 mt-3">
                    <!-- 스터디 상세 정보 -->
                    <article>
                        <div class="row">
                            <!-- 스터디 이름 -->
                            <div class="col-9" style="word-break: break-word;">
                                <h1 class="fw-bolder mb-1" th:text="${study.get('STUDY_NAME')}">스터디 이름</h1>
                            </div>
                            <!-- 스터디 모집 상태 -->
                            <div class="col-3 text-end mt-3" align="right">
                                <h4><span class="badge bg-primary" th:text="${study.get('STUDY_STATE')}">모집 상태</span>
                                </h4>
                            </div>
                        </div>
                        <!-- 스터디 요약 -->
                        <div class="row">
                            <div class="col mt-3">
                                <h5 class="mb-2" th:text="${study.get('STUDY_DESC')}">스터디 요약</h5>
                            </div>
                        </div>
                        <!-- 스터디 개설일시 -->
                        <div class="row">
                            <div class="col-12" align="right">
                                <span>작성일: </span>
                                <span class="mb-2" th:text="${study.get('STUDY_REGDATE')}"></span>
                            </div>
                        </div>
                        <!-- 스터디 카테고리 -->
                        <div class="row mt-3 mb-3">
                            <div class="col-6">
                                <h5 class="d-inline">
                                    <span class="badge badge-light text-dark mr-1"
                                          th:text="${study.get('CATEGORY_TYPE')}">#유형</span>
                                </h5>
                                <h5 class="d-inline">
                                    <span class="badge badge-light text-dark mr-1"
                                          th:text="${study.get('CATEGORY_LANG')}">#사용언어</span>
                                </h5>
                            </div>
                        </div>
                        <!-- 스터디 상세 소개 -->
                        <div class="card mb-4" style="min-height: 300px;">
                            <textarea class="card-body" th:text="${study.get('STUDY_INFO')}" readonly></textarea>
                        </div>
                    </article>
                    <!-- 신청 OR 수정 삭제 -->
                    <div class="row" style="display: flex; justify-content: center;">
                        <!-- 스터디원은 버튼을 보여주지 않음 -->
                        <!-- 스터디 리더인 경우 수정, 삭제 버튼 -->
                        <div th:if="${role.equals('스터디리더')}">
                            <div>
                                <button type="button" class="btn btn-primary" th:onclick="|window.location.href='/study/modifyStudy/${study.get('STUDY_NO')}'|">글 수정</button>
                            </div>
                        </div>

                        <!-- 스터디원, 스터디리더가 아닌 경우 참가 신청 버튼 -->
                        <div th:if="${role.equals('일반회원')}">
                            <button type="button" class="btn btn-primary" id="apply-study" data-toggle="modal" data-target="#applyModal">참가 신청</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div id="studyCommentRoot">
    <div th:replace="fragments/study-comment :: fragment-study-comment" id="studyCommentListView"></div>
</div>
<!-- 본문 종료 -->
<div th:replace="fragments/apply-modal.html :: fragment-applymodal"></div>
<div th:replace="fragments/footer.html :: fragment-footer"></div>

<script th:inline="javascript">
    $(function(){
        // 스터디 지원하기
        $("#applyStudyBtn").click(function(){
            var applyJsonData = {
                studyNo: /*[[${study.get("STUDY_NO")}]]*/ 'studyNo',
                email : /*[[${session.member.email}]]*/ 'email',
                applyContent : $("#applyContent").val()
            };

            $.ajax({
                type:"post",
                url:"/applyStudy",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(applyJsonData),
                success: function (result) {
                    if(result==1){  //신청이 되었다면 return 1
                        alert("신청완료되었습니다. 메인페이지로 이동합니다.");
                    }else{
                        alert("이미 신청되어있습니다. 메인페이지로 이동합니다.");
                    }
                    location.href = "/";
                }
            }); //ajax
        });// applyStudyBtn.click

        // 댓글 등록
        $("#studyCommentRoot").on("click", "#studyCommentRegisterBtn", function() {
            console.log(`댓글 등록`);
            let data = {
                studyCommentContent: $("#studyCommentContent").val(),
                email: /*[[${member.email}]]*/,
                studyNo: $("#studyCommentRegisterBtn").val()
            };
            console.log(data);

            $.ajax({
                type: 'POST',
                url: '/api/registerStudyComment/' + /*[[${studyNo}]]*/,
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data)
            }).done(function (fragment) {
                $("#studyCommentListView").replaceWith(fragment);
            }).fail(function (error) {
                alert(error.message());
            });
        });

        // 댓글 수정
        $("#studyCommentRoot").on("click", ".studyCommentUpdateBtn", function() {
            console.log(`${$(this).val()} 댓글 수정`);

            // 수정, 확인 버튼 토글
            $(this).css('display', 'none');
            $(this).siblings(".studyCommentUpdateSubmitBtn").css('display', 'inline');

            // 삭제, 취소 버튼 토글
            $(this).siblings(".studyCommentDeleteBtn").css('display', 'none');
            $(this).siblings(".studyCommentCancelBtn").css('display', 'inline');

            // p, input 태그 토글
            $(this).parent().siblings().children('p').css('display', 'none');
            $(this).parent().siblings().children('input').css('display', 'inline');

            // p 태그 text를 input의 value로 넣어주기
            $(this).parent().siblings().children('input')
                .val($(this).parent().siblings().children('p').text());
        });

        // 댓글 수정 취소
        $("#studyCommentRoot").on("click", ".studyCommentCancelBtn", function() {
            console.log(`${$(this).val()} 댓글 수정 취소`);

            // p, input 태그 토글
            $(this).parent().siblings().children('input').css('display', 'none');
            $(this).parent().siblings().children('p').css('display', 'inline');

            // 수정, 확인 버튼 토글
            $(this).siblings(".studyCommentUpdateSubmitBtn").css('display', 'none');
            $(this).siblings(".studyCommentUpdateBtn").css('display', 'inline');

            // 삭제, 취소 버튼 토글
            $(this).css('display', 'none');
            $(this).siblings(".studyCommentDeleteBtn").css('display', 'inline');
        });

        // 댓글 수정 제출
        $("#studyCommentRoot").on("click", ".studyCommentUpdateSubmitBtn", function() {
            console.log(`${$(this).val()} 댓글 수정 제출`);

            // 수정, 확인 버튼 토글
            $(this).css('display', 'none');
            $(this).siblings(".studyCommentUpdateBtn").css('display', 'inline');

            let data = {
                studyCommentContent: $(this).parent().siblings().children('input').val(),
                studyCommentNo: $(this).val()
            };
            console.log(data);

            $.ajax({
                type: 'PUT',
                url: '/api/updateStudyComment/' + /*[[${studyNo}]]*/,
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data)
            }).done(function (fragment) {
                $("#studyCommentListView").replaceWith(fragment);
            }).fail(function (error) {
                alert(error.message());
            });
        });

        // 댓글 삭제
        $("#studyCommentRoot").on("click", ".studyCommentDeleteBtn", function() {
            console.log(`${$(this).val()} 댓글 삭제`);
            if(!confirm("댓글을 삭제하시겠습니까?")) {
                return;
            }
            let data = {
                studyCommentNo: $(this).val()
            };
            console.log(data);

            $.ajax({
                type: 'DELETE',
                url: '/api/deleteStudyComment/' + /*[[${studyNo}]]*/,
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data)
            }).done(function (fragment) {
                $("#studyCommentListView").replaceWith(fragment);
            }).fail(function (error) {
                alert(error.message());
            });
        });
    }); //ready
</script>
</body>

</html>